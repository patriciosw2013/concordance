<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core"
    xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:p="http://primefaces.org/ui">

<h:head>
    <title>Concordancia</title>
    <style>
        .parrafo {
            text-align: left;
            padding: 10px !important;
            font: 13px "latoregular", "Trebuchet MS", Arial, Helvetica, sans-serif;
        }

        .task-lists {
            margin: 10px;
            padding: 10px;
            padding-top: 5px;
            padding-bottom: 0;
            font: 14px "latoregular", "Trebuchet MS", Arial, Helvetica, sans-serif;
            color: #282828;
            background-color: #FFFFFF;
            text-align: left;
        }

        .preformatted {
            white-space: pre-wrap;
            text-align: left;
            padding: 10px !important;
            font: 13px "latoregular", "Trebuchet MS", Arial, Helvetica, sans-serif;
            width: 400px;
        }

        .ui-scrollpanel-hbar {
            overflow-x: initial;
        }

        .side-left {
            width: 46% !important;
        }

        .side-right {
            width: 54% !important;
        }

        .panelGroup {
            display: flex;
            justify-content: space-between;
            height: 25px;
        }

        .panelGroup .align-left {
            display: flex;
        }

        .panelGroup .align-right {
            margin-left: auto;
        }
    </style>
</h:head>
<h:body>
    <h:form id="updateForm">
        <script>
            function copyTxt(copyText) {
                navigator.clipboard.writeText(copyText);
            }

            function extractNumber(texto) {
                const match = texto.match(/^\d+/);
                return match ? match[0] : null;
            }

            function scrollPhrase(frase, base, txt) {
                const scrollPanel = document.getElementById('updateForm:pnl');
                if (!scrollPanel) {
                    console.error("No se encontr√≥ el scrollPanel.");
                    return;
                }

                if (base == 'Notas') {
                    frase = extractNumber(txt);
                    if (frase == null) return;
                }

                const walker = document.createTreeWalker(
                    scrollPanel,
                    NodeFilter.SHOW_TEXT,
                    {
                        acceptNode: function (node) {
                            return node.textContent.includes(frase) ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_SKIP;
                        }
                    }
                );

                const match = walker.nextNode();
                if (match) {
                    const range = document.createRange();
                    range.selectNodeContents(match);
                    const rect = range.getBoundingClientRect();
                    const containerRect = scrollPanel.getBoundingClientRect();
                    const offset = rect.top - containerRect.top + scrollPanel.scrollTop;

                    scrollPanel.scrollTo({ top: offset - 20, behavior: 'smooth' });
                } else {
                    console.warn("Frase no encontrada.");
                }
            }
        </script>
        <p:messages id="messages" showDetail="true" closable="true">
            <p:autoUpdate />
        </p:messages>
        <p:dialog id="modalNotes" header="Notas" widgetVar="dlg1" minHeight="300" width="500" showEffect="fade"
            closeOnEscape="true">
            <p:scrollPanel mode="native" id="pnlNotes" style="width: 450px; height: 300px;">
                <h:outputText value="#{concordanciaController.notes}" styleClass="preformatted" escape="false" />
            </p:scrollPanel>
        </p:dialog>
        <div class="task-lists">
            <h:panelGrid columns="9" style="padding-left: 30px; padding-right: 30px; width: 700px;">
                <p:inputText id="float-input" value="#{concordanciaController.input}" />

                <p:commandButton value="Buscar" styleClass="mr-2" style="width: auto" icon="pi pi-search"
                    action="#{concordanciaController.search}" update="searchItems,ctx,resLbl" />

                <p:divider layout="vertical" style="width: 100px;" />

                <p:selectOneMenu id="option" value="#{concordanciaController.base}">
                    <f:selectItems var="o" value="#{concordanciaController.bases}" itemLabel="#{o}" itemValue="#{o}" />
                </p:selectOneMenu>

                <p:divider layout="vertical" style="width: 100px;" />

                <p:link outcome="/evaluate.xhtml" value="Evaluar" target="_blank" style="margin-left: 10px;" />

                <p:link outcome="/reading.xhtml" value="Lectura" target="_blank" style="margin-left: 10px;" />

                <p:link outcome="/interlineal.xhtml" value="Interlineal" target="_blank" style="margin-left: 10px;" />

                <p:link outcome="/search.xhtml" value="Biblia" target="_blank" style="margin-left: 10px;" />
            </h:panelGrid>
            <p:panelGrid columns="2" layout="grid" style="padding: 15px; width: 100%;"
                columnClasses="side-left, side-right">
                <h:panelGroup id="resLbl">
                    <h:outputText rendered="#{not empty concordanciaController.verses}"
                        value="#{concordanciaController.verses.size()} resultados" style="font-size: 14px;" />
                </h:panelGroup>
                <h:panelGroup id="colTitle" styleClass="panelGroup">
                    <h:panelGroup styleClass="align-left">
                        <h:outputText id="txtTitle" style="font-weight: bold; font-size: 14px; padding-right:5px;"
                            value="#{concordanciaController.title}" />
                        <p:commandLink id="lnkCopyRef" value="" rendered="#{not empty concordanciaController.title}"
                            onclick="copyTxt('#{concordanciaController.title}');">
                            <i class="pi pi-clipboard" />
                        </p:commandLink>
                    </h:panelGroup>

                    <p:commandButton value="" rendered="#{not empty concordanciaController.notes}" type="button"
                        icon="pi pi-pen-to-square"
                        styleClass="align-right rounded-button ui-button-secondary ui-button-outlined"
                        style="height:32px;width:32px;" onclick="PF('dlg1').show()" />
                </h:panelGroup>

                <p:selectOneListbox id="searchItems" value="#{concordanciaController.verseId}" scrollHeight="520"
                    style="width: 100%; height: 520px; font-size: 14px;" widgetVar="selIt">
                    <f:selectItems var="o" value="#{concordanciaController.verses}" itemLabel="#{o.text}"
                        itemLabelEscaped="false" itemValue="#{o.recordId}" />
                    <p:ajax event="itemSelect" listener="#{concordanciaController.onSelect()}"
                        update="pnl,modalNotes,colTitle,ctx"
                        oncomplete="copyTxt(PF('selIt').focusedItem.text()); scrollPhrase('#{concordanciaController.input}', '#{concordanciaController.base}', PF('selIt').focusedItem.text());" />
                </p:selectOneListbox>

                <p:scrollPanel mode="native" id="pnl" style="width: 100%; height: 520px;">
                    <h:outputText value="#{concordanciaController.txt}" styleClass="preformatted" escape="false" />
                </p:scrollPanel>
            </p:panelGrid>
            <p:contextMenu id="ctx" for="searchItems">
                <p:menuitem value="Interlineal" icon="pi pi-search" target="_blank"
                    rendered="#{concordanciaController.base eq 'RVR1960'}"
                    url="#{request.scheme}://#{request.serverName}:#{request.serverPort}#{request.contextPath}/interlineal.xhtml?in=#{concordanciaController.verseId}" />
            </p:contextMenu>
        </div>
    </h:form>
</h:body>

</html>